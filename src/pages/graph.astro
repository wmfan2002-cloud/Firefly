---
import KnowledgeGraph from "../components/graph/KnowledgeGraph.svelte";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import type { GraphLink, GraphNode } from "../types/graph";
import { GRAPH_COLORS } from "../types/graph";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "../utils/content-utils";
import { getPostUrlBySlug, getTagUrl } from "../utils/url-utils";

const posts = await getSortedPosts();
const tags = await getTagList();
const categories = await getCategoryList();

const nodes: GraphNode[] = [];
const links: GraphLink[] = [];

categories.forEach((cat) => {
	nodes.push({
		id: `cat-${cat.name}`,
		group: 3,
		name: cat.name,
		val: Math.max(5, Math.min(cat.count * 2, 18)),
		url: cat.url,
	});
});

tags.forEach((tag) => {
	nodes.push({
		id: `tag-${tag.name}`,
		group: 2,
		name: tag.name,
		val: Math.max(3, Math.min(tag.count + 2, 12)),
		url: getTagUrl(tag.name),
	});
});

posts.forEach((post) => {
	nodes.push({
		id: post.id,
		group: 1,
		name: post.data.title,
		val: 5,
		url: getPostUrlBySlug(post.id),
	});

	if (post.data.category) {
		const catName =
			typeof post.data.category === "string"
				? post.data.category
				: String(post.data.category);
		if (nodes.some((n) => n.id === `cat-${catName}`)) {
			links.push({ source: post.id, target: `cat-${catName}`, value: 3 });
		}
	}

	if (post.data.tags) {
		post.data.tags.forEach((tagName) => {
			if (nodes.some((n) => n.id === `tag-${tagName}`)) {
				links.push({ source: post.id, target: `tag-${tagName}`, value: 1 });
			}
		});
	}
});
---

<MainGridLayout
	title={i18n(I18nKey.knowledgeGraph)}
	description={i18n(I18nKey.knowledgeGraphDescription)}
>
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative bg-[var(--card-bg)] transition-all duration-300 border border-[var(--line-color)]"
	>
		<div class="absolute top-4 left-4 z-10 bg-[var(--card-bg)]/90 backdrop-blur-sm p-3 rounded-lg shadow-sm text-sm border border-[var(--line-color)]">
			<ul class="list-none m-0 p-0">
				<li class="flex items-center gap-2 mb-1.5">
					<span class="w-3 h-3 rounded-full" style={`background-color: ${GRAPH_COLORS.post}`}></span>
					<span class="text-[var(--content-text)]">{i18n(I18nKey.knowledgeGraphPost)}</span>
				</li>
				<li class="flex items-center gap-2 mb-1.5">
					<span class="w-3 h-3 rounded-full" style={`background-color: ${GRAPH_COLORS.category}`}></span>
					<span class="text-[var(--content-text)]">{i18n(I18nKey.knowledgeGraphCategory)}</span>
				</li>
				<li class="flex items-center gap-2">
					<span class="w-3 h-3 rounded-full" style={`background-color: ${GRAPH_COLORS.tag}`}></span>
					<span class="text-[var(--content-text)]">{i18n(I18nKey.knowledgeGraphTag)}</span>
				</li>
			</ul>
		</div>

		<div class="w-full p-4 h-[75vh]">
			<KnowledgeGraph client:load nodes={nodes} links={links} isWidget={false} />
		</div>
	</div>
</MainGridLayout>
